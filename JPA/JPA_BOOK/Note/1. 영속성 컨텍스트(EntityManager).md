# Entity Manager Factory

- 어플리케이션에서 사용하는 Entity 매니저 인스턴스를 관리하기 위해 사용.
- 엔티티매니저팩토리 생성 시, 커넥션풀도 함께 생성함.
- 같은 엔티티매니저팩토리를 통해 생성되는 엔티티매니저는 같은 DB를 접속함.
- 한번 생성 된 후, 어플리케이션 전체에 공유.
- 엔티티 매니저 팩토리는 생성할때마다 리소스를 많이 잡아먹으므로, 사용시 유의해야한다.

# Entity Manager(**영속성 컨텍스트**)

## 새로운 엔티티를 영속화를 하면..

1. 엔티티를 **1차 캐시**에 저장한다.
2. 쓰기 지연 SQL 저장소에 엔티티에대한 Insert쿼리를 저장한다. (트랜잭션을 지원하는 쓰기지연 기능)

## 준영속 상태의 특징

- 준영속 상태에서는 아무리 수정을 해도 데이터베이스에 반영되지 않는다.
- 대신 비영속 상태와 다른점은 식별자값을 갖고있는다는 것이다.

## 준영속 상태의 엔티티를 병합(Merge) 시..

- **새로운 영속성컨텍스트를 생성하여 엔티티를 병합한다.**

## 엔티티 조회

- 영속성 컨텍스트는 식별자값으로 엔티티를 구분한다. → 그래서 Entity 객체에는 @Id(식별자값) 어노테이션이 붙은 필드가 필수적으로 있어야한다. 없을 경우 Compile 에러.
- 엔티티 조회 시, 식별자값을 통해 1차캐시에 해당 데이터가 있는지 조회한다.
- 만약 1차캐시에 조회할려고하는 데이터가 없을 경우, 그때 DB에 Select쿼리를 날려 조회한다.

## 엔티티 수정

- JPA는 엔티티를 영속성 컨텍스트에 보관할 때 최초 상태를 복사하여 저장해둔다. → **스냅샷**
- 트랜잭션을 커밋하면 엔티티매니저 내부에서 **flush**가 된다.
- **flush 시점에 스냅샷과 현재 엔티티를 비교하여 변경된 부분에 대한 수정 쿼리를 생성하여 쓰기지연 저장소에 보낸다.**
- 쓰기지연 저장소의 SQL을 DB에 보낸다.
- 트랜잭션을 커밋한다.

## 엔티티 삭제

- 엔티티 삭제 시, 삭제를 진행한 엔티티를 영속성 컨텍스트에서 제거한다.

## 플러시(Flush)

- 플러시가 일어나면 영속성 컨텍스트의 변경 내용을 DB에 저장한다.
- 엔티티 매니저의 플러시모드 타입을 지정할 수 있다.
  1. AUTO → 커밋이나 쿼리를 실행할 때 플러시
  2. COMMIT → 커밋할 때만 플러시